const WebSocket=require("ws"),Discord=require("discord.js"),DiscordClient=new Discord.Client,Sessions=require("./sessionInstance"),Messenger=require("./serverMessenger"),game=require("./game"),Server=new WebSocket.Server({port:process.env.PORT||5e3,clientTracking:!0}),ClientMap=[];Server.on("connection",function(e){console.log("Client connected"),ClientMap.push({socket:e,connectionTimestamp:Date.now()}),e.on("message",function(s){Messenger.Receive(s,e)}),e.on("close",function(){for(const s of ClientMap)if(s.socket===e){const e=Date.now()-s.connectionTimestamp;LogDiscord("login-duration",Math.ceil(e/1e3).toString()),ClientMap.splice(ClientMap.indexOf(s),1);break}DisconnectPlayerFromSessions(e)})});const defaultField={topOccupations:[],bottomOccupations:[]};for(let e=0;e<8;e++)defaultField.topOccupations[e]=4,defaultField.bottomOccupations[e]=4,defaultField.topOccupations[e+8]=0,defaultField.bottomOccupations[e+8]=0;const DefaultSessionSettings={side:"bottom",stepTime:300,field:defaultField,reverseLevel:2};function CreateNewSession(e,s){let o=100;for(;null!=Sessions.GetSession(o);)o++;const n={};return Object.assign(n,DefaultSessionSettings),n.side="bottom",n.stepTime=100*(5-e+1),n.reverseLevel=s,Sessions.NewSession(o,n),o}function RemoveSession(e){Sessions.DeleteSession(e)}function ConnectPlayerToSession(e,s,o,n){if(null==Sessions.GetSession(e))return!1;const t=Sessions.GetSession(e);if(null!=t.bottomPlayer&&null!=t.topPlayer)return!1;let i,r;Sessions.GetSession(e).connectPlayer(s,o,n),Sessions.GetSession(e).bottomPlayer===s?(i=Sessions.GetSession(e).topPlayer,r=!0):(i=Sessions.GetSession(e).bottomPlayer,r=!1),Sessions.GetSession(e).statusAddPlayer();const l=Sessions.GetSession(e).settings.stepTime;if("Full"===Sessions.GetSession(e).status){const s=Sessions.GetSession(e).bottomPlayer,o=Sessions.GetSession(e).topPlayer,n=Sessions.GetSession(e).bottomName,t=Sessions.GetSession(e).topName,i=game.FieldToString(Sessions.GetSession(e).game.topOccupations,Sessions.GetSession(e).game.bottomOccupations),r=Sessions.GetSession(e).game.turn;return Messenger.Send("GSB?T"+l.toString()+"?O"+t+"?F"+i+"?C"+r+"?",s),Messenger.Send("GST?T"+l.toString()+"?O"+n+"?F"+i+"?C"+r+"?",o),Sessions.GetSession(e).updateStatus("Playing"),!0}if("Playing"===Sessions.GetSession(e).status){Messenger.Send("RN"+o+"?",i);const n=game.FieldToString(Sessions.GetSession(e).game.topOccupations,Sessions.GetSession(e).game.bottomOccupations),t=Sessions.GetSession(e).game.turn;if(r){const o=Sessions.GetSession(e).topName;Messenger.Send("GSB?T"+l.toString()+"?O"+o+"?F"+n+"?C"+t+"?",s)}else{const o=Sessions.GetSession(e).bottomName;Messenger.Send("GST?T"+l.toString()+"?O"+o+"?F"+n+"?C"+t+"?",s)}return!0}}function DisconnectPlayerFromSessions(e){for(const[s,o]of Sessions.SessionsMap){let n,t=!1;if(o.bottomPlayer===e&&(o.disconnectPlayer(!1),t=!0,null!=o.topPlayer&&(n=o.topPlayer)),o.topPlayer===e&&(o.disconnectPlayer(!0),t=!0,null!=o.bottomPlayer&&(n=o.bottomPlayer)),null!=n&&Messenger.Send("L",n),t){o.statusRemovePlayer()&&RemoveSession(s)}}}function ProcessMove(e,s,o){let n=null,t=null;for(const[s,o]of Sessions.SessionsMap){if(o.bottomPlayer===e){n=o,t="bottom";break}if(o.topPlayer===e){n=o,t="top";break}}null!=n&&o===t&&n.connector.ClientToServerCallbacks.StartMove.call(n.connector.Server,s,o)}function SendMessageToPlayersOfSession(e,s){const o=Sessions.SessionsMap.get(e);null!=o.bottomPlayer&&Messenger.Send(s,o.bottomPlayer),null!=o.topPlayer&&Messenger.Send(s,o.topPlayer)}console.log("Server up!"),module.exports.CreateNewSession=CreateNewSession,module.exports.ConnectPlayerToSession=ConnectPlayerToSession,module.exports.DisconnectPlayerFromSessions=DisconnectPlayerFromSessions,module.exports.ProcessMove=ProcessMove,module.exports.SendMessageToPlayersOfSession=SendMessageToPlayersOfSession,DiscordClient.login(process.env.TOKEN);const DiscordChannels=new Map;function LogDiscord(e,s){const o=DiscordChannels.get(e);o||console.log("Invalid channel name: "+e),o.send(s)}DiscordClient.on("ready",function(){console.log("Discord connected!");for(const[e,s]of DiscordClient.channels.cache)DiscordChannels.set(s.name,s)}),module.exports.LogDiscord=LogDiscord;